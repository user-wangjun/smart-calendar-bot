# 农历日期显示与节假日标记功能实施计划

&gt; **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标:** 为日历组件添加农历日期显示和节假日视觉标记功能

**架构:** 
- 扩展现有 `lunarCalendar.js`，添加更多节假日数据和缓存机制
- 修改 `Calendar.vue`，集成农历工具并添加UI显示
- 使用Map缓存计算结果以优化性能

**技术栈:** Vue 3, JavaScript, Tailwind CSS

---

## 任务1: 扩展 lunarCalendar.js - 添加更多传统节日

**文件:**
- 修改: `src/utils/lunarCalendar.js:70-77`

**步骤:**

1. 扩展 `lunarHolidays` 对象，添加更多传统节日
2. 修改内容：
```javascript
const lunarHolidays = {
  '01-01': { name: '春节', type: 'traditional' },
  '01-02': { name: '春节', type: 'traditional' },
  '01-03': { name: '春节', type: 'traditional' },
  '01-15': { name: '元宵节', type: 'traditional' },
  '02-02': { name: '龙抬头', type: 'traditional' },
  '05-05': { name: '端午节', type: 'traditional' },
  '07-07': { name: '七夕节', type: 'traditional' },
  '07-15': { name: '中元节', type: 'traditional' },
  '08-15': { name: '中秋节', type: 'traditional' },
  '09-09': { name: '重阳节', type: 'traditional' },
  '10-01': { name: '寒衣节', type: 'traditional' },
  '12-08': { name: '腊八节', type: 'traditional' },
  '12-23': { name: '小年', type: 'traditional' },
  '12-30': { name: '除夕', type: 'traditional' }
};
```

3. 验证：确保所有节日数据正确添加

---

## 任务2: 扩展 lunarCalendar.js - 添加缓存机制

**文件:**
- 修改: `src/utils/lunarCalendar.js:79-83`
- 修改: `src/utils/lunarCalendar.js:236-253`

**步骤:**

1. 在构造函数中添加缓存
```javascript
constructor () {
  this.baseDate = new Date(1900, 0, 31);
  this.baseMonth = 11;
  this._cache = new Map(); // 添加缓存
}
```

2. 修改 `getCalendarInfo` 方法，支持缓存
```javascript
getCalendarInfo (date = new Date()) {
  // 生成缓存键
  const cacheKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  
  // 检查缓存
  if (this._cache.has(cacheKey)) {
    return this._cache.get(cacheKey);
  }
  
  const lunar = this.solarToLunar(date);
  const huangli = this.getHuangli(date);
  const holidays = this.getHolidays(date, lunar);
  
  const result = {
    solar: {
      year: date.getFullYear(),
      month: date.getMonth() + 1,
      day: date.getDate(),
      weekDay: date.getDay(),
      weekDayText: weekDays[date.getDay()]
    },
    lunar,
    huangli,
    holidays
  };
  
  // 存入缓存
  this._cache.set(cacheKey, result);
  
  return result;
}
```

3. 验证：确保缓存机制正常工作

---

## 任务3: 修改 Calendar.vue - 导入农历工具

**文件:**
- 修改: `src/views/Calendar.vue:317-333`

**步骤:**

1. 在导入部分添加 `lunarCalendar`
```javascript
import lunarCalendar from '@/utils/lunarCalendar';
```

2. 验证：确保导入正确

---

## 任务4: 修改 Calendar.vue - 添加农历和节假日信息

**文件:**
- 修改: `src/views/Calendar.vue:366-395`

**步骤:**

1. 修改 `calendarDays` 计算属性，添加农历和节假日信息
```javascript
const calendarDays = computed(() =&gt; {
  const year = currentYear.value;
  const month = currentMonth.value;
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);

  const days = [];

  // Padding for previous month
  const firstDayOfWeek = firstDay.getDay();
  for (let i = firstDayOfWeek; i &gt; 0; i--) {
    const d = new Date(year, month, 1 - i);
    const calendarInfo = lunarCalendar.getCalendarInfo(d);
    days.push({ 
      date: d, 
      isCurrentMonth: false, 
      isToday: isSameDate(d, new Date()),
      lunar: calendarInfo.lunar,
      holidays: calendarInfo.holidays
    });
  }

  // Current month
  for (let i = 1; i &lt;= lastDay.getDate(); i++) {
    const d = new Date(year, month, i);
    const calendarInfo = lunarCalendar.getCalendarInfo(d);
    days.push({ 
      date: d, 
      isCurrentMonth: true, 
      isToday: isSameDate(d, new Date()),
      lunar: calendarInfo.lunar,
      holidays: calendarInfo.holidays
    });
  }

  // Padding for next month to complete 6 weeks (42 cells)
  const remaining = 42 - days.length;
  for (let i = 1; i &lt;= remaining; i++) {
    const d = new Date(year, month + 1, i);
    const calendarInfo = lunarCalendar.getCalendarInfo(d);
    days.push({ 
      date: d, 
      isCurrentMonth: false, 
      isToday: isSameDate(d, new Date()),
      lunar: calendarInfo.lunar,
      holidays: calendarInfo.holidays
    });
  }

  return days;
});
```

2. 验证：确保计算属性正确返回农历和节假日信息

---

## 任务5: 修改 Calendar.vue - 模板中显示农历日期和节假日

**文件:**
- 修改: `src/views/Calendar.vue:80-125`

**步骤:**

1. 修改日期单元格模板
```vue
&lt;div
  v-for="(day, index) in calendarDays"
  :key="index"
  class="day-cell"
  :class="{
    'other-month': !day.isCurrentMonth,
    'today': day.isToday,
    'has-events': getEventsForDay(day.date).length &gt; 0,
    'holiday-statutory': day.holidays.some(h =&gt; h.type === 'statutory'),
    'holiday-traditional': day.holidays.some(h =&gt; h.type === 'traditional')
  }"
  @click="handleDayClick(day)"
&gt;
  &lt;!-- 节假日名称 --&gt;
  &lt;div v-if="day.holidays.length &gt; 0" class="holiday-name"&gt;
    {{ day.holidays[0].name }}
  &lt;/div&gt;
  
  &lt;!-- Date Number --&gt;
  &lt;div class="day-header"&gt;
    &lt;span class="day-number" :class="{ 'today-badge': day.isToday }"&gt;
      {{ day.date.getDate() }}
    &lt;/span&gt;
    &lt;button
      class="add-event-btn"
      @click.stop="openAddModal(day.date)"
      aria-label="添加事件"
    &gt;
      &lt;Plus class="add-icon" /&gt;
    &lt;/button&gt;
  &lt;/div&gt;
  
  &lt;!-- 农历日期 --&gt;
  &lt;div v-if="day.lunar" class="lunar-date"&gt;
    {{ day.lunar.monthText }}{{ day.lunar.dayText }}
  &lt;/div&gt;

  &lt;!-- Events --&gt;
  &lt;div class="day-events"&gt;
    &lt;div
      v-for="event in getEventsForDay(day.date).slice(0, 3)"
      :key="event.id"
      class="event-tag"
      :class="getEventColorClass(event.type)"
      @click.stop="openEditModal(event)"
    &gt;
      &lt;span class="event-time"&gt;{{ formatTime(event.startDate) }}&lt;/span&gt;
      &lt;span class="event-title"&gt;{{ event.title }}&lt;/span&gt;
    &lt;/div&gt;
    &lt;div
      v-if="getEventsForDay(day.date).length &gt; 3"
      class="more-events"
      @click.stop="handleDayClick(day)"
    &gt;
      +{{ getEventsForDay(day.date).length - 3 }} 更多
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
```

2. 验证：确保模板正确显示农历和节假日

---

## 任务6: 修改 Calendar.vue - 添加样式

**文件:**
- 修改: `src/views/Calendar.vue:898-1199`

**步骤:**

1. 添加节假日背景样式
```css
.day-cell.holiday-statutory {
  background: rgba(59, 130, 246, 0.15);
}

.dark .day-cell.holiday-statutory {
  background: rgba(59, 130, 246, 0.2);
}

.day-cell.holiday-traditional {
  background: rgba(239, 68, 68, 0.15);
}

.dark .day-cell.holiday-traditional {
  background: rgba(239, 68, 68, 0.2);
}
```

2. 添加节假日名称样式
```css
.holiday-name {
  font-size: 0.7rem;
  font-weight: 600;
  color: #ef4444;
  text-align: center;
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dark .holiday-name {
  color: #f87171;
}

.day-cell.holiday-statutory .holiday-name {
  color: #3b82f6;
}

.dark .day-cell.holiday-statutory .holiday-name {
  color: #60a5fa;
}
```

3. 添加农历日期样式
```css
.lunar-date {
  font-size: 0.7rem;
  color: var(--main-text-muted);
  margin-bottom: 0.25rem;
}

.dark .lunar-date {
  color: var(--dark-text-muted);
}

.day-cell.other-month .lunar-date {
  opacity: 0.5;
}
```

4. 调整 day-header 样式
```css
.day-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.25rem;
}
```

5. 添加响应式样式
```css
@media (max-width: 767px) {
  .holiday-name {
    font-size: 0.6rem;
  }
  
  .lunar-date {
    font-size: 0.6rem;
  }
}
```

6. 验证：确保样式正确显示

---

## 任务7: 测试验证

**文件:**
- 测试: 手动运行项目验证功能

**步骤:**

1. 运行开发服务器：`npm run dev`
2. 验证农历日期显示正确
3. 验证节假日标记显示正确
4. 验证响应式布局正常
5. 验证性能（切换月份时无明显延迟）

---

## 验收标准

- [ ] 农历日期显示格式正确（正月、初一）
- [ ] 所有传统节日都有标记
- [ ] 节假日视觉效果符合方案A
- [ ] 性能优化生效（无重复计算）
- [ ] 在不同屏幕尺寸下显示正常
- [ ] 主题色彩保持一致

