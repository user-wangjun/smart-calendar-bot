# 部署文档 - 自然语言日程创建功能

**文档版本**: 1.0  
**创建日期**: 2026-01-31  
**部署版本**: v1.1.0  
**功能分支**: feature/natural-language-schedule  

---

## 1. 部署概述

### 1.1 部署目标
将自然语言日程创建功能安全、稳定地部署到生产环境。

### 1.2 部署策略
采用**蓝绿部署**策略，确保零停机时间和快速回滚能力。

### 1.3 部署环境
- **生产环境**: https://calendar-assistant.example.com
- **预发布环境**: https://staging-calendar-assistant.example.com
- **监控平台**: https://monitoring.example.com

---

## 2. 部署前检查清单

### 2.1 代码检查

| 检查项 | 状态 | 负责人 | 备注 |
|--------|------|--------|------|
| 代码审查完成 | ⬜ | 技术负责人 | 所有代码已Review |
| 单元测试通过 | ✅ | CI系统 | 48/48通过 |
| 集成测试通过 | ✅ | CI系统 | 11/11通过 |
| 回归测试通过 | ✅ | QA团队 | 59/59通过 |
| 代码合并到主分支 | ⬜ | 开发人员 | feature -> main |

### 2.2 文档检查

| 检查项 | 状态 | 负责人 | 备注 |
|--------|------|--------|------|
| 需求文档更新 | ✅ | 产品经理 | 已同步 |
| API文档更新 | ✅ | 开发人员 | 已更新 |
| 用户手册更新 | ⬜ | 技术写作 | 待更新 |
| 部署文档完成 | ✅ | 运维团队 | 本文档 |
| 回滚方案准备 | ✅ | 运维团队 | 已准备 |

### 2.3 环境检查

| 检查项 | 状态 | 负责人 | 备注 |
|--------|------|--------|------|
| 预发布环境验证 | ⬜ | 运维团队 | 功能正常 |
| 生产环境备份 | ⬜ | 运维团队 | 数据已备份 |
| 监控告警配置 | ⬜ | 运维团队 | 已配置 |
| 回滚方案验证 | ⬜ | 运维团队 | 已测试 |

---

## 3. 部署步骤

### 3.1 预发布环境部署

```bash
# 1. 切换到预发布环境
git checkout staging

# 2. 合并功能分支
git merge feature/natural-language-schedule

# 3. 安装依赖
npm ci

# 4. 构建应用
npm run build

# 5. 运行测试
npm run test

# 6. 部署到预发布环境
npm run deploy:staging

# 7. 验证部署
curl https://staging-calendar-assistant.example.com/health
```

**验证清单**:
- [ ] 应用正常启动
- [ ] 自然语言创建日程功能正常
- [ ] 现有功能无异常
- [ ] 性能指标正常

### 3.2 生产环境部署

#### 阶段1: 准备（部署前30分钟）

```bash
# 1. 通知相关人员
# - 发送部署通知到团队群
# - 确认无紧急业务操作

# 2. 备份当前版本
git tag backup-v1.0.0-$(date +%Y%m%d-%H%M%S)
git push origin backup-v1.0.0-20260131-120000

# 3. 备份数据
npm run backup:data

# 4. 检查监控状态
npm run check:monitoring
```

#### 阶段2: 部署（部署时间: 5分钟）

```bash
# 1. 切换到生产分支
git checkout main

# 2. 合并功能分支
git merge feature/natural-language-schedule --no-ff -m "feat: 添加自然语言日程创建功能 v1.1.0"

# 3. 打版本标签
git tag v1.1.0
git push origin v1.1.0

# 4. 安装依赖
npm ci --production

# 5. 构建应用
npm run build:production

# 6. 蓝绿部署 - 部署到绿色环境
npm run deploy:green

# 7. 健康检查
npm run health:check:green

# 8. 切换流量到绿色环境
npm run switch:traffic:green

# 9. 监控5分钟
npm run monitor:5min
```

#### 阶段3: 验证（部署后30分钟）

```bash
# 1. 功能验证
npm run verify:functionality

# 2. 性能验证
npm run verify:performance

# 3. 错误检查
npm run check:errors

# 4. 用户反馈监控
npm run monitor:feedback
```

---

## 4. 部署验证

### 4.1 功能验证

| 验证项 | 验证方法 | 预期结果 | 状态 |
|--------|----------|----------|------|
| 自然语言解析 | 输入"明天下午3点开会" | 显示确认卡片 | ⬜ |
| 事件创建 | 点击确认按钮 | 事件创建成功 | ⬜ |
| 现有聊天功能 | 发送普通消息 | AI正常回复 | ⬜ |
| 日历显示 | 查看日历 | 新事件显示正常 | ⬜ |
| 移动端适配 | 手机浏览器访问 | 界面正常 | ⬜ |

### 4.2 性能验证

| 验证项 | 目标值 | 验证方法 | 状态 |
|--------|--------|----------|------|
| 页面加载时间 | < 3秒 | Lighthouse | ⬜ |
| 解析响应时间 | < 100ms | 浏览器DevTools | ⬜ |
| 内存使用 | 稳定 | 任务管理器 | ⬜ |
| CPU使用 | < 50% | 任务管理器 | ⬜ |

### 4.3 错误监控

| 验证项 | 目标值 | 验证方法 | 状态 |
|--------|--------|----------|------|
| JavaScript错误 | 0 | Sentry | ⬜ |
| API错误率 | < 1% | 监控平台 | ⬜ |
| 404错误 | 0 | 日志分析 | ⬜ |

---

## 5. 回滚方案

### 5.1 自动回滚触发条件

以下情况将**自动触发回滚**:
- 错误率超过 5%
- 页面加载时间超过 10秒
- 核心功能不可用
- 收到严重告警

### 5.2 手动回滚步骤

```bash
# 1. 立即停止流量
npm run stop:traffic

# 2. 切换回蓝色环境（旧版本）
npm run switch:traffic:blue

# 3. 验证回滚成功
npm run verify:rollback

# 4. 通知团队
npm run notify:rollback

# 5. 分析问题
npm run analyze:issue

# 6. 修复问题
# ...

# 7. 重新部署
# ...
```

### 5.3 数据回滚

如果需要回滚数据:

```bash
# 1. 停止应用
npm run stop:app

# 2. 恢复数据
npm run restore:data backup-v1.0.0-20260131-120000

# 3. 重启应用
npm run start:app

# 4. 验证数据
npm run verify:data
```

---

## 6. 监控配置

### 6.1 应用监控

```yaml
# 监控项
metrics:
  - name: parse_success_rate
    type: gauge
    description: 自然语言解析成功率
    threshold: 
      warning: 85%
      critical: 80%
  
  - name: parse_response_time
    type: histogram
    description: 解析响应时间
    threshold:
      warning: 100ms
      critical: 500ms
  
  - name: event_creation_success
    type: counter
    description: 事件创建成功次数
  
  - name: user_confirmation_rate
    type: gauge
    description: 用户确认率
    threshold:
      warning: 70%
      critical: 60%
```

### 6.2 告警规则

```yaml
alerts:
  - name: NLP_Parse_Error_High
    condition: parse_success_rate < 80%
    duration: 5m
    severity: critical
    action: notify_slack, page_oncall
  
  - name: NLP_Response_Time_High
    condition: parse_response_time_p95 > 500ms
    duration: 10m
    severity: warning
    action: notify_slack
  
  - name: Event_Creation_Failure
    condition: event_creation_error_rate > 5%
    duration: 5m
    severity: critical
    action: notify_slack, page_oncall
```

### 6.3 日志监控

```javascript
// 关键日志点
const LOG_POINTS = {
  // 解析开始
  PARSE_START: 'nlp_parse_start',
  
  // 解析成功
  PARSE_SUCCESS: 'nlp_parse_success',
  
  // 解析失败
  PARSE_ERROR: 'nlp_parse_error',
  
  // 用户确认
  USER_CONFIRM: 'event_user_confirm',
  
  // 用户取消
  USER_CANCEL: 'event_user_cancel',
  
  // 事件创建成功
  EVENT_CREATE_SUCCESS: 'event_create_success',
  
  // 事件创建失败
  EVENT_CREATE_ERROR: 'event_create_error',
};
```

---

## 7. 部署后检查

### 7.1 即时检查（部署后5分钟）

- [ ] 应用正常启动
- [ ] 无JavaScript错误
- [ ] 自然语言功能可用
- [ ] 现有功能正常
- [ ] 性能指标正常

### 7.2 短期检查（部署后1小时）

- [ ] 用户反馈正常
- [ ] 错误率正常
- [ ] 响应时间正常
- [ ] 无异常告警

### 7.3 长期检查（部署后24小时）

- [ ] 功能使用率统计
- [ ] 用户满意度调查
- [ ] 性能趋势分析
- [ ] 错误日志审查

---

## 8. 附录

### 8.1 部署脚本

```bash
#!/bin/bash
# deploy.sh - 部署脚本

set -e

echo "开始部署自然语言日程创建功能..."

# 检查参数
ENV=${1:-staging}
VERSION=${2:-v1.1.0}

if [ "$ENV" != "staging" ] && [ "$ENV" != "production" ]; then
  echo "错误: 环境必须是 staging 或 production"
  exit 1
fi

echo "部署环境: $ENV"
echo "版本: $VERSION"

# 执行部署
npm run deploy:$ENV

# 验证部署
npm run verify:$ENV

echo "部署完成!"
```

### 8.2 回滚脚本

```bash
#!/bin/bash
# rollback.sh - 回滚脚本

set -e

echo "开始回滚..."

VERSION=${1:-v1.0.0}

echo "回滚到版本: $VERSION"

# 执行回滚
git checkout $VERSION
npm ci
npm run build:production
npm run deploy:production

echo "回滚完成!"
```

### 8.3 联系信息

| 角色 | 姓名 | 联系方式 | 职责 |
|------|------|----------|------|
| 技术负责人 | | | 技术决策 |
| 运维负责人 | | | 部署执行 |
| 产品经理 | | | 业务确认 |
| 测试负责人 | | | 质量验证 |

### 8.4 参考文档

- [测试报告](./测试报告.md)
- [回滚方案](./回滚方案.md)
- [监控配置](./监控配置.md)

---

**部署状态**: 待执行  
**部署窗口**: 2026-02-01 02:00-04:00 (低峰期)  
**预计时长**: 30分钟  
**回滚时间**: < 5分钟  

